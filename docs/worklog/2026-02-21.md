# 2026-02-21

## 1) SAVC Studio 实时联调修复与页面解耦

- 对话目标
  - 修复 Studio 开发联调中的核心问题：回复格式混乱、疑似思考内容外露、回复状态不可感知、终端不可稳定操作、项目历史区空白。
  - 在修复完成后，将 `studio` 页面代码做结构解耦，降低后续维护成本。

- 执行内容
  - 后端修复（`savc-ui/vite.config.ts`）：
    - 增加 `extractReplyTextFromAgentPayload`，不再只取首段文本，改为“累积段智能收敛”，降低回复被截成中间态的概率。
    - 保留混合输出 JSON 解析与 ANSI 清洗逻辑，增强 CLI 输出容错。
    - PTY shell 默认改为更稳定的 `/bin/bash -il`（可由环境变量覆盖），降低 zsh 初始化脚本导致的异常提示。
  - 前端修复（`savc-ui/public/studio/studio-core.js` + `studio.css` + `index.html`）：
    - 增加消息清洗与格式化渲染：去除常见思考块标记、移除模型头前缀、将 Markdown 渲染为可读结构（标题/列表/代码块/引用/链接）。
    - 增加实时状态反馈：`idle/working/done/error`，含状态点动画与发送中“typing dots”提示。
    - 开发/陪伴通道都接入 pending 状态，发送过程中显示“处理中”，完成后回落 idle。
    - 移除开发消息中模型前缀拼接，避免 `[provider/model]` 污染正文。
    - 新增本地会话缓存与项目历史持久化（localStorage）：消息、最近打开文件、最近输入需求可恢复。
    - 上下文区新增“项目任务/历史项目/历史需求”列，减少空白态。
  - 终端可用性修复（`savc-ui/public/studio/studio-terminal.js`）：
    - 修复输入桥重复绑定风险，增强连接状态控制。
    - 增加点击终端区域重连、连接后自动 focus。
    - 首次连接自动输出当前工作区路径与分支，确保“当前项目上下文”可见。
  - 页面解耦（`savc-ui/public/studio/index.html`）：
    - 将内联代码拆分为独立资源：`studio.css`、`studio-core.js`、`studio-codemirror.js`、`studio-terminal.js`。

- 修改文件
  - `savc-ui/vite.config.ts`
  - `savc-ui/public/studio/index.html`
  - `savc-ui/public/studio/studio.css`
  - `savc-ui/public/studio/studio-core.js`
  - `savc-ui/public/studio/studio-codemirror.js`
  - `savc-ui/public/studio/studio-terminal.js`

- 验证结果
  - `node --check savc-ui/public/studio/studio-core.js`：通过
  - `node --check savc-ui/public/studio/studio-terminal.js`：通过
  - `node --check savc-ui/public/studio/studio-codemirror.js`：通过
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `pnpm --dir savc-ui exec vite build`：通过
  - `POST /__savc/llm/chat`（`scope=dev`）返回 `ok:true`，实测返回 `SAVC_OK`
  - `GET /__savc/progress/snapshot`、`GET /__savc/task-runtime/snapshot`：返回正常
  - `GET /studio/`（`-L`）可命中新入口并加载外置资源

- 备注
  - 终端与 LLM 在线联调依赖本地 `savc-ui dev` 运行及模型供应侧可用性。

## 2) 全局系统存储落地（SQLite + MySQL 预留 + YAML 容灾）与界面监控

- 对话目标
  - 增加全局系统存储层：主存使用 SQLite，缓存使用 Redis（不可用时降级内存缓存），预留 MySQL 接口探活，保留 YAML 容灾备份。
  - 在 SAVC 管理界面新增数据库服务状态监控。
  - 在 SAVC Studio 新增存储运行日志界面并接入真实接口。

- 执行内容
  - 新增后端存储服务模块 `savc-ui/storage/global-storage.ts`：
    - `node:sqlite` 初始化与表结构创建（`kv_store`、`runtime_logs`）。
    - 缓存层策略：优先 Redis（`SAVC_REDIS_URL/REDIS_URL`），失败自动回退 memory cache。
    - MySQL 预留探活：读取 `SAVC_MYSQL_DSN/MYSQL_URL`，执行 TCP 可达性检测，返回状态但不写业务数据。
    - YAML 容灾：周期写入 `config/storage/savc-disaster-backup.yaml`，包含状态快照、KV、最近日志。
  - 在 `savc-ui/vite.config.ts` 集成全局存储：
    - 新增 API：
      - `GET /__savc/storage/status`
      - `GET /__savc/storage/logs`
      - `GET/POST /__savc/storage/kv`
      - `POST /__savc/storage/backup`
    - 将 runtime / llm / terminal 关键事件写入存储日志。
    - 在任务 create/control 时同步持久化任务快照到 KV。
  - 管理界面（dashboard）接入真实存储状态：
    - `savc-ui/src/ui/mock/index.ts` 新增 `getStorageStatus()`、`getStorageRuntimeLogs()`。
    - `savc-ui/src/ui/views/dashboard.ts` 新增“数据库与存储服务”状态卡与“存储运行日志”卡。
  - Studio 接入存储状态与日志：
    - `savc-ui/public/studio/index.html` 新增两个面板：`storage-service-status`、`storage-runtime-logs`。
    - `savc-ui/public/studio/studio-core.js` 新增 `refreshStorageStatus()`、`refreshStorageLogs()`、对应渲染函数，并纳入主轮询。
  - 工程治理：
    - `.gitignore` 新增 `config/storage/`，避免把运行时 SQLite/YAML 备份数据误提交。

- 修改文件
  - `savc-ui/storage/global-storage.ts`
  - `savc-ui/vite.config.ts`
  - `savc-ui/src/ui/mock/types.ts`
  - `savc-ui/src/ui/mock/index.ts`
  - `savc-ui/src/ui/views/dashboard.ts`
  - `savc-ui/public/studio/index.html`
  - `savc-ui/public/studio/studio-core.js`
  - `.gitignore`

- 验证结果
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `pnpm --dir savc-ui exec vite build`：通过（含 SQLite experimental warning）
  - `GET /__savc/storage/status`：返回 `ok:true`，显示 `sqlite/cache/mysql/yaml` 状态与路径
  - `GET /__savc/storage/logs?limit=5`：返回真实日志
  - `POST /__savc/storage/kv` + `GET /__savc/storage/kv?key=smoke.demo`：读写成功
  - `GET /studio/`：存在 `storage-service-status` 与 `storage-runtime-logs` 面板标记

- 备注
  - 若需启用 Redis，请安装/配置 Redis 服务并设置 `SAVC_REDIS_URL`。
  - MySQL 当前为“预留与探活”模式，业务写入仍以 SQLite 为主。

## 3) 全局存储方案联调验收（本轮）

- 对话目标
  - 验证“全局系统存储 + 管理界面监控 + Studio 运行日志”是否已经接入真实接口并可在线工作。

- 执行内容
  - 核对关键实现文件与路由：`savc-ui/storage/global-storage.ts`、`savc-ui/vite.config.ts`、`savc-ui/public/studio/*`、`savc-ui/src/ui/views/dashboard.ts`。
  - 执行构建级验证：`tsc --noEmit`、`vite build`。
  - 在线联调 `5174` 端口运行服务，验收存储接口与页面入口：
    - `GET /__savc/storage/status`
    - `GET /__savc/storage/logs`
    - `POST/GET /__savc/storage/kv`
    - `GET /studio/` 与 `GET /workbench/` 重定向
  - 检查运行时产物：`config/storage/savc-system.sqlite`、`config/storage/savc-disaster-backup.yaml`。

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `pnpm --dir savc-ui exec vite build`：通过
  - `GET /__savc/storage/status`：`ok:true`，当前模式 `primary=sqlite`、`cache=memory`、`mysql=disabled`、`yaml=online`
  - `GET /__savc/storage/logs?limit=6`：返回真实日志（含 server/storage 启动日志）
  - `POST /__savc/storage/kv` + `GET /__savc/storage/kv?key=smoke.storage.key`：读写成功
  - `GET /studio/` 与 `GET /workbench/`：均 `302` 到 `/studio/index.html`

- 备注
  - `5174` 端口已有本地 `savc-ui` 进程监听（PID 40673），本轮复用了该实例进行接口验收。
  - Redis 在未设置 `SAVC_REDIS_URL` 时会自动使用内存缓存，属于预期降级行为。

## 4) Studio 小终端改为顶部 Touch Bar（防遮挡）

- 对话目标
  - 解决 Studio 小终端遮挡右侧信息的问题。
  - 将入口改为顶部 touch bar：无任务时短条、有任务时自动变长，点击才展开工作区。

- 执行内容
  - `savc-ui/public/studio/index.html`
    - 在开发页 `dev-tab-bar` 增加 touch bar 锚点与按钮（`vsc-touchbar-anchor` / `vsc-touchbar`）。
    - 调整工作区标题栏关闭按钮行为为“收起”而非直接隐藏。
  - `savc-ui/public/studio/studio.css`
    - 新增 touch bar 的三态样式：待命短条、任务长条、展开态高亮。
    - 工作区窗口改为顶部停靠弹出层（不再使用右下角缩放 mini 浮窗）。
  - `savc-ui/public/studio/studio-core.js`
    - 新增任务感知逻辑：根据 dev 任务/运行状态动态调整 touch bar 长度与文本。
    - 新增 `toggleVSCodeFromTouchbar()`，点击 touch bar 展开/收起工作区。
    - 新增 `positionVscWidget()`，展开面板按 touch bar 位置自动定位并随窗口/侧栏变化重排。
    - 去除原拖拽浮窗逻辑，避免误拖和遮挡回归。

- 修改文件
  - `savc-ui/public/studio/index.html`
  - `savc-ui/public/studio/studio.css`
  - `savc-ui/public/studio/studio-core.js`
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `node --check savc-ui/public/studio/studio-core.js`：通过
  - `node --check savc-ui/public/studio/studio-terminal.js`：通过
  - `pnpm --dir savc-ui exec vite build`：通过

- 备注
  - 终端连接仍按原机制在展开时触发（`/__savc/terminal`），保证仅在需要时占用资源。

## 5) Studio「是否仍为 Mock」快速核对

- 对话目标
  - 确认 Studio 工作区窗口中的文件树/文件内容/Git/终端输出是否来自真实接口，而非 mock 数据。

- 执行内容
  - 启动 `savc-ui` 开发服务后，直接对网关接口做实测：
    - `GET /__savc/fs/tree`
    - `GET /__savc/fs/read?path=Stop-SAVC.cmd`
    - `GET /__savc/git/status`
    - `POST /__savc/terminal/exec`（`pwd`）
  - 对照返回内容与当前仓库真实状态（分支、改动、文件内容）。

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `fs/tree` 返回真实仓库树（含 `AGENTS.md`、`savc-ui`、`config/storage` 等目录）。
  - `fs/read` 返回 `Stop-SAVC.cmd` 实际文件内容与大小。
  - `git/status` 返回当前真实分支 `main`、真实 `staged/unstaged/untracked` 列表。
  - `terminal/exec` 执行 `pwd` 返回当前真实工作目录路径。

- 备注
  - 若 `5174` 未启动，页面会落到占位/回退状态，视觉上会像“mock”。

## 6) Studio 工作区与内核仓库隔离

- 对话目标
  - 避免 Studio 内置开发工作区直接暴露 SAVC 内核仓库，防止与“交给媛媛开发的项目”混淆。

- 执行内容
  - 后端隔离（`savc-ui/vite.config.ts`）：
    - 新增 `studioWorkspaceRoot`（默认 `.runtime/studio-workspace`，支持 `SAVC_STUDIO_WORKSPACE_ROOT` / `SAVC_STUDIO_WORKSPACE` 覆盖）。
    - 启动时自动创建隔离工作区，并初始化 `README.md` 说明用途。
    - 将以下接口根目录从 `repoRoot` 改为 `studioWorkspaceRoot`：
      - `GET /__savc/fs/tree`
      - `GET /__savc/fs/read`
      - `POST /__savc/fs/write`
      - `GET /__savc/fs/search`
      - `POST /__savc/terminal/exec`
      - `WS /__savc/terminal`
    - Git 接口改为“仅认工作区自身仓库”：
      - 若工作区并非独立 Git 仓库（即仅处于上层仓库内），`/git/status` 返回 `isGitRepo:false` 与空变更列表。
      - `/git/add`、`/git/commit` 在非独立仓库场景返回 `workspace_not_git_repo`。
  - 前端标识（`savc-ui/public/studio/index.html` + `studio-core.js`）：
    - 将工作区标题与根节点标签从固定 `SAVC` 改为动态 `workspace.name`，减少误判。
    - Git 面板在 `isGitRepo:false` 时显示“仅文件编辑/终端能力”提示。

- 修改文件
  - `savc-ui/vite.config.ts`
  - `savc-ui/public/studio/index.html`
  - `savc-ui/public/studio/studio-core.js`
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `pnpm --dir savc-ui exec vite build`：通过
  - `GET /__savc/fs/tree`：返回根路径为 `.runtime/studio-workspace`（不再是内核仓库）
  - `GET /__savc/git/status`：返回 `isGitRepo:false`，不再映射内核仓库改动
  - `POST /__savc/terminal/exec` 执行 `pwd`：返回工作目录 `.runtime/studio-workspace`
  - `GET /__savc/fs/read?path=Stop-SAVC.cmd`：返回 `not_found`（工作区隔离生效）

- 备注
  - 若后续要让工作区启用独立 Git，请在 `studioWorkspaceRoot` 内单独 `git init`。

## 7) 服务重启（savc-ui）

- 对话目标
  - 按用户请求重启当前联调用服务。

- 执行内容
  - 重启 `savc-ui` 开发服务（`pnpm --dir savc-ui dev`）。
  - 复核端口监听与入口可访问性。
  - 复核关键状态接口可响应。

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - 服务监听：`TCP *:5174`，进程 `node`（PID 65975）
  - `GET /studio/`：返回 `302`，重定向到 `/studio/index.html`
  - `GET /__savc/storage/status`：返回 `ok:true`

- 备注
  - 本轮重启的是 `savc-ui`（Studio/管理界面联调服务）。

## 8) 任务等待超时监听与处置

- 对话目标
  - 处理 Studio 出现“任务等待超时 / LLM 502”的联调问题，并确认是否存在服务级阻塞。

- 执行内容
  - 对 `5174` 进行接口监听与探测：
    - `GET /__savc/task-runtime/snapshot`
    - `GET /__savc/storage/logs`
    - `POST /__savc/llm/chat`
  - 定位到关键风险点：`/__savc/llm/chat` 使用 `execFileSync` 同步调用 OpenClaw，LLM 侧慢/阻塞时会冻结 Node 事件循环，放大为“整条链路卡住”体感。
  - 修复为异步子进程调用：
    - 在 `savc-ui/vite.config.ts` 新增 `execFileTextAsync(...)`
    - 将 `/__savc/llm/chat` 从 `execFileSync` 改为 `await execFileTextAsync(...)`
  - 回归并发场景：
    - 在 LLM 请求进行时并发请求 `task-runtime/storage`，确认可持续快速返回，不再被 LLM 调用阻塞。

- 修改文件
  - `savc-ui/vite.config.ts`
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `pnpm --dir savc-ui exec vite build`：通过
  - 并发探测结果：
    - `task-runtime/storage` 在 LLM 请求期间仍返回 `HTTP 200` 且亚毫秒级响应
    - `llm/chat` 可成功返回 `HTTP 200`（例如 `provider=openai-codex model=gpt-5.2`）
  - 存储日志可见 `llm chat failed(empty_output)` 的间歇性上游失败记录，说明当前剩余风险主要在模型侧稳定性，不再是网关主线程阻塞。

- 备注
  - 该修复降低了“单次 LLM 异常拖死全局接口”的风险；LLM 供应侧仍可能偶发失败，建议后续叠加重试/回退策略。

## 9) Studio 回复改为流式返回（SSE）

- 对话目标
  - 将 Studio 的 LLM 返回从“一次性整段回复”改为“流式增量显示”，提升等待期可见性与交互反馈。

- 执行内容
  - 后端（`savc-ui/vite.config.ts`）：
    - 为 `POST /__savc/llm/chat` 增加 `stream` 模式（SSE）：
      - 事件：`start` / `status` / `delta` / `done` / `error` / `ping`
      - `stream=true` 时使用 `spawn` 启动 OpenClaw 子进程，边执行边推送状态事件。
      - 完成后将回复按块拆分推送 `delta`，并在 `done` 事件附带 `provider/model/sessionId` 元信息。
    - 保持非流式兼容：未启用 `stream` 时仍返回原 JSON 结构，不改现有协议字段。
  - 前端（`savc-ui/public/studio/studio-core.js`）：
    - `requestLlmReply` 改为优先请求流式，并解析 SSE 帧进行增量拼接。
    - 增加流式消息状态管理：创建/更新/完成/丢弃流式 assistant 气泡。
    - `companion/dev` 两条发送链路改为边收边渲染，失败时回退错误消息。
    - 消息渲染层支持流式光标与 pending 去重（流式中不再叠加“等待气泡”）。
  - 样式（`savc-ui/public/studio/studio.css`）：
    - 新增 `stream-cursor` 闪烁光标与 `streaming-bubble` 样式。

- 修改文件
  - `savc-ui/vite.config.ts`
  - `savc-ui/public/studio/studio-core.js`
  - `savc-ui/public/studio/studio.css`
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `node --check savc-ui/public/studio/studio-core.js`：通过
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`：通过
  - `POST /__savc/llm/chat`（`stream=true`）实测可收到：
    - `event:start`
    - `event:status`
    - 多段 `event:delta`
    - `event:done`（含 `provider=openai-codex`、`model=gpt-5.2`）
  - `POST /__savc/llm/chat`（默认非流式）保持 `ok:true` JSON 响应。

- 备注
  - 当前 OpenClaw CLI 在本地场景下仍以“完成后输出为主”，因此首 token 时延主要受上游模型影响；前端已具备完整流式渲染能力。

## 10) `journal-web` 子项目现状盘点（yuanyuan 版本）

- 对话目标
  - 快速核对 `savc-core/journal-web` 当前完成度与可运行状态，确认是否已达到可继续联调的 MVP 基线。

- 执行内容
  - 盘点项目结构与核心实现：
    - 路由：`/today`、`/timeline`、`/calendar`、`/entry/[id]`。
    - 数据层：Dexie + IndexedDB 本地持久化（离线可用）。
    - 交互：快速记录（⌘/Ctrl+K）、时间轴筛选、日历聚合、详情编辑/删除、JSON 导入导出。
  - 执行可用性验证：
    - `npm run lint`
    - `npm run build`
  - 定位构建阻断：
    - `timeline` 页直接使用 `useSearchParams()`，在 Next.js 16 生产构建下触发 Suspense 边界错误。

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `npm run lint`：通过。
  - `npm run build`：失败，错误为 `useSearchParams() should be wrapped in a suspense boundary at page "/timeline"`。
  - 阻断位置：`savc-core/journal-web/src/app/(shell)/timeline/page.tsx`。

- 备注
  - 当前版本可用于本地开发验证（`dev`），但尚未通过生产构建门槛，需先修复 `timeline` 的 Suspense 包装问题。

## 11) `journal-web` 运行态启动与端口确认

- 对话目标
  - 按用户要求将 `savc-core/journal-web` 跑起来并给出可访问地址。

- 执行内容
  - 检查 `3000` 端口占用情况，确认已有 `next-server (v16.1.6)` 进程在监听。
  - 尝试以 `3001` 启动新实例时命中 `.next/dev/lock`（同项目已有 dev 进程），因此复用现有实例。
  - 验证访问可用性：
    - `GET /` 返回 `307` 并重定向到 `/today`
    - `GET /today` 返回 `200`

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - 服务地址可用：`http://127.0.0.1:3000`
  - 页面入口重定向正常，`/today` 正常响应。

- 备注
  - 若需要“独立新实例”而不是复用现有实例，可先结束当前 `next dev` 进程再按指定端口重启。

## 12) `journal-web` 加载失败应急修复（dev 进程假在线）

- 对话目标
  - 处理“页面加载不出来”的现场问题，恢复 `journal-web` 可访问状态。

- 执行内容
  - 诊断发现：`3000` 端口有 `next-server` 监听，但 `HTTP` 请求超时（无响应），属于进程假在线。
  - 结束失活进程并重启：
    - 停止旧 `next dev / next-server` 进程
    - 重新执行 `npm run dev -- --hostname 127.0.0.1 --port 3000`
  - 重新验活：
    - `GET /` 返回 `307 -> /today`
    - `GET /today` 返回 `200`

- 修改文件
  - `docs/worklog/2026-02-21.md`

- 验证结果
  - `http://127.0.0.1:3000` 可访问
  - `http://localhost:3000` 可访问

- 备注
  - 当前服务由本轮启动会话托管；如终端会话被关闭，服务会一起退出，需要再次启动。
