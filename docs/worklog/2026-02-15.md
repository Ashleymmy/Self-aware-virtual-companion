# 工作日志 - 2026-02-15

## 记录 01

- 对话目标：修复 Telegram/Discord 对话“发消息后长时间无回复”的问题。
- 执行内容：
  - 复核网关状态与会话日志，确认主因是模型 Provider 不稳定（`wzw` 403、`anyrouter` 超时），导致会话卡在模型调用阶段。
  - 在 `~/.openclaw/openclaw.json` 增加并启用本机 CLI 兜底：
    - `agents.defaults.cliBackends.claude-cli.command = /mnt/g/nodejs/claude`
    - 主模型切换为 `claude-cli/opus-4.5`
    - 回退模型保留 `anyrouter/claude-haiku-4-5-20251001`
  - 重启 Gateway：`openclaw gateway restart`。
- 修改文件：
  - `docs/worklog/2026-02-15.md`（新增）
  - `docs/worklog/INDEX.md`（更新）
  - `~/.openclaw/openclaw.json`（运行态热修复，仓库外）
- 验证结果：
  - `openclaw models status --json`：`defaultModel=claude-cli/opus-4.5`，fallback 生效。
  - `openclaw agent --session-id hotfix-dialogue --message "只回复: 现在正常" --json`：PASS（返回 `现在正常`，耗时约 6.5s，provider=`claude-cli`）。
  - `openclaw channels status --json`：Telegram/Discord 均 `running=true`。

## 记录 02

- 对话目标：修复 Telegram 侧出现“这不是 HEARTBEAT 任务/不在开发者工具职责范围”的异常回复。
- 执行内容：
  - 确认当前主模型为 `claude-cli/opus-4.5`，并定位到会话上下文污染风险：心跳任务与私聊共享主会话键。
  - 更新运行态配置：
    - `session.dmScope = per-channel-peer`
    - `agents.defaults.heartbeat.session = heartbeat-main`
  - 重置主会话键 `agent:main:main`（仅删除会话索引项，不影响其他会话），让 Telegram 下一轮对话走新上下文。
  - 重启 Gateway 使配置立即生效。
- 修改文件：
  - `docs/worklog/2026-02-15.md`（更新）
  - `~/.openclaw/openclaw.json`（运行态更新，仓库外）
  - `~/.openclaw/agents/main/sessions/sessions.json`（运行态会话重置，仓库外）
- 验证结果：
  - `openclaw config get session` 返回 `{"dmScope":"per-channel-peer"}`。
  - `openclaw config get agents.defaults.heartbeat` 返回 `{"session":"heartbeat-main"}`。
  - `openclaw agent --channel telegram --to 6260789852 --message "哈喽" --json`：PASS（正常中文回复）。
  - 会话索引新增 `agent:main:heartbeat-main`，说明心跳已与主对话隔离。

## 记录 03

- 对话目标：继续后续开发计划（暂不处理管理界面重构），优先修复编排主链可用性并固化会话隔离默认配置。
- 执行内容：
  - 从 `openclaw-history.bundle` 挂载 `bundle/savc-extensions` 分支并恢复 `openclaw/extensions/savc-orchestrator` 全量实现（含 `savc_route` / `savc_decompose` / `savc_spawn_expert` / `savc_agent_status` / `savc_voice_call` / `savc_image_generate` 及测试）。
  - 安装并构建 `openclaw` 子项目依赖，恢复 `dist/entry.js` 供网关/插件命令正常运行。
  - 更新 `scripts/setup.sh`：默认写入 `session.dmScope=per-channel-peer` 与 `agents.defaults.heartbeat.session=heartbeat-main`。
  - 更新 `scripts/llm_enable_failover.sh`：在补丁模式下同步写入上述会话隔离字段，避免仅改模型链时丢失会话安全设置。
  - 更新 `README.md`：补充会话隔离默认行为说明。
- 修改文件：
  - `openclaw/extensions/savc-orchestrator/`（恢复）
  - `scripts/setup.sh`（更新）
  - `scripts/llm_enable_failover.sh`（更新）
  - `README.md`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `cd openclaw && pnpm exec vitest run extensions/savc-orchestrator/src/*.test.ts`：PASS（7 files, 24 tests）
  - `bash scripts/test_phase4b_plugin.sh`：PASS
  - `bash scripts/test_phase5d.sh`：PASS
  - `bash scripts/test_phase5e.sh`：PASS（live smoke 按默认配置跳过）
  - `bash scripts/test_phase5.sh`：PASS（5c/5d/5e 全通过）
  - `bash -n scripts/setup.sh scripts/llm_enable_failover.sh`：PASS
  - `bash scripts/llm_enable_failover.sh --dry-run` 输出包含：
    - `session.dmScope = per-channel-peer`
    - `agents.defaults.heartbeat.session = heartbeat-main`

## 记录 04

- 对话目标：确认当前整体项目阶段进度与可交付状态。
- 执行内容：
  - 检查最近提交与工作区状态，确认已落地里程碑与未提交改动范围。
  - 核对 `README.md` 与 `docs/SAVC功能拓展路线图.md` 的阶段状态声明。
  - 执行 `scripts/test_phase_status.sh` 获取阶段级测试快照，并读取 `phase2` 失败日志定位原因。
- 修改文件：
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - 阶段状态：Phase 0~5 完成，Phase 6 计划中（M-F1~M-F5 待实现）。
  - `scripts/test_phase_status.sh`：Phase 1 PASS，Phase 2 FAIL（`live smoke env missing`），Phase 3 PASS。
  - 近期核心回归：`test_phase4b_plugin.sh`、`test_phase5.sh` 均 PASS（本次会话已验证）。

## 记录 05

- 对话目标：在不涉及管理界面重构的前提下，启动 Phase 6 首批开发（非 UI 基础层）。
- 执行内容：
  - 新增 `savc-core/orchestrator/live2d.mjs`，实现 `phase6-v1` 信号协议：
    - 情绪标签标准化与表情参数映射（emotion -> expression/motion）
    - mock 口型帧生成（voice text -> lipSync frames）
    - 交互动作信号映射（interaction -> motion）
  - 新增 `savc_live2d_signal` 工具并接入 `savc-orchestrator`：
    - `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.ts`
    - 注册到 `openclaw/extensions/savc-orchestrator/index.ts`
    - 扩展 `paths.ts`/`types.ts` 以加载并约束 `live2d.mjs` 模块
  - 新增 `savc-core/agents/live2d.yaml`，并更新 `router.mjs`/`router.test.mjs` 支持 Live2D 请求路由。
  - 新增阶段脚本与报告：
    - `scripts/test_phase6.sh`
    - `tests/phase6-test-report.md`
    - `package.json` 增加 `test:phase6`
  - 更新文档状态：`README.md`、`docs/SAVC功能拓展路线图.md` 标注 Phase 6“基础信号层进行中”。
- 修改文件：
  - `savc-core/orchestrator/live2d.mjs`（新增）
  - `tests/orchestrator/live2d.test.mjs`（新增）
  - `savc-core/agents/live2d.yaml`（新增）
  - `savc-core/orchestrator/router.mjs`（更新）
  - `tests/orchestrator/router.test.mjs`（更新）
  - `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.ts`（新增）
  - `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.test.ts`（新增）
  - `openclaw/extensions/savc-orchestrator/src/paths.ts`（更新）
  - `openclaw/extensions/savc-orchestrator/src/types.ts`（更新）
  - `openclaw/extensions/savc-orchestrator/index.ts`（更新）
  - `openclaw/extensions/savc-orchestrator/README.md`（更新）
  - `openclaw/extensions/savc-orchestrator/openclaw.plugin.json`（更新）
  - `scripts/phase5_enable_plugins.sh`（更新）
  - `scripts/test_phase4b.sh`（更新）
  - `scripts/test_phase6.sh`（新增）
  - `tests/phase6-test-report.md`（新增）
  - `package.json`（更新）
  - `README.md`（更新）
  - `docs/SAVC功能拓展路线图.md`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `node tests/orchestrator/live2d.test.mjs`：PASS
  - `cd openclaw && pnpm exec vitest run extensions/savc-orchestrator/src/*.test.ts`：PASS（8 files, 27 tests）
  - `bash scripts/test_phase6.sh`：PASS
  - `bash scripts/test_phase4b.sh`：PASS（含 live2d 路由场景）
  - `bash scripts/test_phase5.sh`：PASS（5c/5d/5e 回归通过）

## 记录 06

- 对话目标：修复 `savc_voice_call` 在 Phase 5d/6 验收脚本中的回归失败，并恢复阶段回归稳定性。
- 执行内容：
  - 复现并定位 `scripts/test_phase5d.sh` 的 `savc_voice_call initiate failed` 问题，确认根因是 `voice-call` 使用全局持久化目录，存在历史未结束通话导致并发上限命中。
  - 更新 `scripts/test_phase5d.sh`：
    - 向临时配置注入独立 `voice-call` `store` 路径（`TMP_ROOT/voice-store`）。
    - 保留并继续使用临时 webhook 端口，确保测试环境隔离且可重复执行。
  - 更新 `scripts/test_phase6.sh`：
    - 同样注入独立 `voice-call` `store` 路径与临时 webhook 端口。
    - 在 `savc_voice_call initiate` 后新增 `end` 收尾步骤，避免再次写入未结束通话。
    - 新增 end 响应断言，补齐脚本闭环。
- 修改文件：
  - `scripts/test_phase5d.sh`（更新）
  - `scripts/test_phase6.sh`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `bash scripts/test_phase5d.sh`：PASS（18 PASS, 0 FAIL）
  - `bash scripts/test_phase6.sh`：PASS（18 PASS, 0 FAIL）
  - `bash scripts/test_phase5.sh`：PASS（5c/5d/5e 全通过）
- 备注：
  - 该修复不改业务逻辑，只增强测试隔离性与可重复性，避免用户本机历史状态污染阶段验收。

## 记录 07

- 对话目标：提交当前回归修复后继续推进 Phase 6，完善 Live2D 在非 UI 层的 M-F2/M-F3 可验收链路。
- 执行内容：
  - 完成提交：`feat(phase6): add live2d signal layer and stabilize phase5/6 tests`（`14a68ffea`）。
  - 扩展 `savc-core/orchestrator/live2d.mjs`：
    - 新增任务级推断能力：`classifyLive2DSource`、`inferEmotionFromMessage`、`inferInteractionType`。
    - 新增计划层接口：`buildLive2DPlan`、`formatLive2DPlan`，统一输出 `live2dSource/live2dEmotion/live2dMotion` 标记。
  - 扩展 `savc-core/orchestrator/lifecycle.mjs`：
    - 增加 `live2d` 内建执行分支，支持直接从任务文本生成可消费信号计划。
  - 补充自动化验证：
    - `tests/orchestrator/live2d.test.mjs` 新增推断/计划断言。
    - `tests/orchestrator/lifecycle.test.mjs` 新增 `live2d` 分支执行断言。
    - `scripts/test_phase6.sh` 新增 lifecycle 交互信号校验步骤。
  - 同步文档：
    - `README.md`、`docs/SAVC功能拓展路线图.md`、`tests/phase6-test-report.md` 更新当前 Phase 6 后端进度描述。
- 修改文件：
  - `savc-core/orchestrator/live2d.mjs`（更新）
  - `savc-core/orchestrator/lifecycle.mjs`（更新）
  - `tests/orchestrator/live2d.test.mjs`（更新）
  - `tests/orchestrator/lifecycle.test.mjs`（更新）
  - `scripts/test_phase6.sh`（更新）
  - `README.md`（更新）
  - `docs/SAVC功能拓展路线图.md`（更新）
  - `tests/phase6-test-report.md`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `node tests/orchestrator/live2d.test.mjs`：PASS
  - `node tests/orchestrator/lifecycle.test.mjs`：PASS
  - `bash scripts/test_phase6.sh`：PASS（19 PASS, 0 FAIL）
  - `bash scripts/test_phase5.sh`：PASS（5c/5d/5e 全通过）

## 记录 08

- 对话目标：按“推进一步，提交一步”继续 Phase 6，补齐 M-F4 的编排层联动能力（非 UI）。
- 执行内容：
  - 更新 `savc-core/orchestrator/decomposer.mjs`：
    - 新增 `hasLive2DSignal` / `hasInteractionSignal` / `hasVoiceSignal` 检测。
    - 新增联动规则：当请求同时包含 Live2D 交互与语音信号时，自动拆解为串行任务 `live2d -> voice`。
  - 更新 `tests/orchestrator/decomposer.test.mjs`：
    - 增加 `点击模型并语音播报一句欢迎回来` 场景断言，验证 `live2d -> voice` 与依赖关系。
  - 更新 `scripts/test_phase6.sh`：
    - 增加 `decomposer` 链路校验，确保阶段脚本中可直接验收交互+语音联动拆解。
- 修改文件：
  - `savc-core/orchestrator/decomposer.mjs`（更新）
  - `tests/orchestrator/decomposer.test.mjs`（更新）
  - `scripts/test_phase6.sh`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `node tests/orchestrator/decomposer.test.mjs`：PASS
  - `bash scripts/test_phase6.sh`：PASS（20 PASS, 0 FAIL）

## 记录 09

- 对话目标：按“推进一步，提交一步”继续 Phase 6，增强 `savc_live2d_signal` 工具的任务文本自动推断能力。
- 执行内容：
  - 更新 `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.ts`：
    - 新增 `task` 参数（自然语言任务文本）。
    - 当 `task` 存在且 `buildLive2DPlan` 可用时，走计划推断路径，自动解析 source/emotion/interaction 并产出信号。
    - 保持原有 `source/message` 显式模式兼容，未传 `task` 时行为不变。
  - 更新 `openclaw/extensions/savc-orchestrator/src/types.ts`：
    - 增加 `Live2DPlanResult` 类型与 `Live2DModule.buildLive2DPlan` 可选签名。
  - 更新 `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.test.ts`：
    - 新增 `task` 推断单测，断言 `buildLive2DPlan` 调用与返回 source=voice。
  - 更新 `scripts/test_phase6.sh`：
    - 增加 `savc_live2d_signal` 的 task 推断调用与断言（验证 `source=voice` 且含 `lipSync` 帧）。
  - 更新文档：
    - `openclaw/extensions/savc-orchestrator/README.md` 补充 `task` 参数说明。
    - `tests/phase6-test-report.md` 补充 task 推断验收项。
- 修改文件：
  - `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.ts`（更新）
  - `openclaw/extensions/savc-orchestrator/src/tool-live2d-signal.test.ts`（更新）
  - `openclaw/extensions/savc-orchestrator/src/types.ts`（更新）
  - `scripts/test_phase6.sh`（更新）
  - `openclaw/extensions/savc-orchestrator/README.md`（更新）
  - `tests/phase6-test-report.md`（更新）
  - `docs/worklog/2026-02-15.md`（更新）
- 验证结果：
  - `cd openclaw && pnpm exec vitest run extensions/savc-orchestrator/src/tool-live2d-signal.test.ts`：PASS（4 tests）
  - `bash scripts/test_phase6.sh`：PASS（21 PASS, 0 FAIL）
