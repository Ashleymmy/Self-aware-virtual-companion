# 工作日志 — 2026-02-18

## 记录 01

**对话目标**: 全面审查 SAVC 项目现状，诊断 mock/real 断层，制定实际运行联调执行计划

**执行内容**:
1. 对项目进行了全面的代码审计，涵盖 savc-core（10 个 Agent YAML + 编排器模块）、openclaw 网关（扩展系统 + 60+ 工具）、savc-ui（Web 管理界面）
2. 诊断出 5 个核心断层：
   - savc-orchestrator 插件未在 `~/.openclaw/openclaw.json` 中启用
   - 仅 main 和 technical 两个 Agent 注册到 OpenClaw，其余 8 个未注册
   - 主 Agent 无 SOUL.md，不知道该使用编排工具
   - 记忆搜索被禁用（`memorySearch.enabled: false`）
   - YAML 中模型 ID 与 OpenClaw 实际可用模型不匹配
3. 编写了完整的 7 步执行计划，包含每个 Agent 的具体配置（SOUL.md + models.json）、验证方法、风险应对和回退方案

**修改文件**:
- `docs/SAVC实际运行联调执行计划.md`（新建，完整执行计划文档）

**验证结果**: 未执行（仅规划阶段）

**备注**: 核心发现是断层不在代码逻辑而在配置层——框架代码（编排器、real-session-adapter、工具注册）都已就绪，只是没有被正确连接。下一步按计划执行 Step 1-6 即可打通完整链路。

---

## 记录 02

**对话目标**: 按计划执行 SAVC 实际运行联调——启用插件、注册 Agent、配置工具、验证端到端链路

**执行内容**:

### 已完成
1. **启用 savc-orchestrator 插件**（openclaw.json）
   - 添加 `plugins.load.paths` 指向扩展目录
   - 添加 `plugins.entries.savc-orchestrator` 配置（config 子键嵌套格式）
   - 验证：`openclaw plugins list` 显示 savc-orchestrator 状态为 `loaded`

2. **启用记忆搜索**
   - `memorySearch.enabled` 从 `false` 改为 `true`
   - `openclaw status` 显示 `Memory: 15 files · vector ready · fts ready`

3. **注册 8 个 Agent**（`~/.openclaw/agents/`）
   - companion、memory、technical、creative、tooling、voice、vision、vibe-coder
   - 每个 Agent 配置了 SOUL.md（基于角色的人格指令）和 agent/models.json（模型映射）
   - `openclaw status` 显示 `Agents: 9`

4. **配置主 Agent 编排能力**
   - 为 main agent 创建 SOUL.md，包含完整的媛媛人格 + 编排工具使用指南
   - 包括决策流程：简单闲聊→直接回复，复杂任务→savc_route→savc_spawn_expert

5. **修复工具可见性**（发现并解决 3 个关键问题）
   - **optional:true 过滤**: savc 工具注册为 optional，需要 allowlist 才能可见
   - **tools.allow vs tools.alsoAllow**: `allow` 是 AND 门不是 OR 门，必须用 `alsoAllow` 才能叠加到 profile 上
   - **claude-cli 后端不支持插件工具**: `claude-cli/opus-4.5` 模型委托给 Claude CLI 子进程，该进程无法访问网关级插件工具。切换 `agents.defaults.model.primary` 为 `wzw/claude-sonnet-4-5-20250929`（API-based）

6. **验证工具注册成功**
   - 通过 `openclaw agent` 的 `systemPromptReport` 确认 agent 的 tool set 中包含全部 7 个 savc 工具：
     - `savc_route` / `savc_decompose` / `savc_spawn_expert`
     - `savc_agent_status` / `savc_voice_call`
     - `savc_image_generate` / `savc_live2d_signal`

### 未完成
- **端到端功能测试**: API 提供商（anyrouter 和 wzw）在测试时返回 403/500 错误，无法完成实际 LLM 调用验证
- **多 Agent 协作测试**: 依赖 API 可用性

**修改文件**:
- `~/.openclaw/openclaw.json` — 启用插件、记忆、alsoAllow、切换主模型
- `~/.openclaw/agents/main/SOUL.md` — 新建，含编排指令
- `~/.openclaw/agents/{companion,memory,technical,creative,tooling,voice,vision,vibe-coder}/SOUL.md` — 新建
- `~/.openclaw/agents/{companion,memory,technical,creative,tooling,voice,vision,vibe-coder}/agent/models.json` — 新建

**验证结果**:
- 插件加载：已验证（`openclaw plugins list` → loaded）
- Agent 注册：已验证（`openclaw status` → 9 agents）
- 记忆搜索：已验证（vector ready + fts ready）
- 工具注册：已验证（systemPromptReport 显示 7 个 savc 工具）
- 端到端 LLM 调用：未完成（API 提供商不可用）

**关键发现**:
1. OpenClaw 插件工具用 `optional: true` 注册时，需要在 `tools.alsoAllow` 中声明才能对 agent 可见
2. `claude-cli` 后端（本地 Claude CLI 子进程）不能使用网关级插件工具，必须使用 API-based 模型
3. 插件配置必须在 `plugins.entries.<id>.config` 子键下，不能放在 entry 根级
4. OpenClaw 用 jiti 运行时加载 TypeScript 插件，无需编译

---

## 记录 03

**对话目标**: 完成端到端 LLM 调用联调——解决 API 提供商问题，打通完整调用链路

**执行内容**:

### API 提供商诊断与解决

1. **anyrouter**: 间歇性 500 "负载已达上限"——免费代理站容量不稳定
2. **wzw**: 秒返 403 "Your request was blocked"——OpenClaw 完整 14K 系统提示 + 8K 工具 schema 触发代理站的内容过滤器（无论用 Claude 还是 Qwen 模型，只要发大 system prompt 就被拦截）
3. **CODE** (`code.claudex.us.ci`): 非流式 curl 正常，但 OpenClaw 强制使用 streaming 模式，CODE 在 streaming 模式下返回空响应或垃圾数据
4. **GGBOOM** (`ai.qaq.al`): 仅支持 OpenAI Responses API 格式（`/v1/responses`），有 GPT-5.2 等模型，无内容过滤——**最终成功的提供商**

### 关键配置修改

1. 创建 `~/.openclaw/agents/main/agent/auth-profiles.json`
   - OpenClaw 不从 models.json 的 apiKey 字段读取密钥
   - 使用独立的 auth store（auth-profiles.json），格式为 `{ version: 1, profiles: { "provider:default": { type, provider, key } } }`

2. 注册 GGBOOM 为 `openai-responses` 格式提供商
   - models.json 中添加 `"ggboom"` provider，`"api": "openai-responses"`
   - auth-profiles.json 中添加 `"ggboom:default"` profile

3. 配置模型优先级
   - primary: `ggboom/gpt-5.2`
   - fallbacks: `anyrouter/claude-haiku-4-5-20251001`, `code/claude-sonnet-4-5-20250929`

### 端到端测试结果

| 测试场景 | 结果 | 关键指标 |
|---------|------|---------|
| 情感对话："今天好累啊，抱抱我" | 成功 | 首句用"宝贝"，高甜安抚，完全符合 SOUL.md 人格 |
| 复合任务：天气+TCP握手 | 成功 | 模型调用了 `savc_spawn_expert(agent:"weather")`；因 weather agent 未注册返回 AGENT_NOT_FOUND 后优雅降级，直接回答技术问题 |
| 英文问候 | 成功 | 2.2s 响应，7946 input tokens |

### 已验证的完整链路

```
用户消息 → OpenClaw 网关 → 模型选择（ggboom/gpt-5.2）
→ 14K 系统提示注入（SOUL.md + AGENTS.md + TOOLS.md + IDENTITY.md + USER.md）
→ 12 个工具注册（含 7 个 savc 工具）
→ LLM 生成响应（含 tool_call）
→ savc_spawn_expert 执行
→ 结果返回用户
```

**修改文件**:
- `~/.openclaw/agents/main/agent/auth-profiles.json` — 新建，4 个提供商的 API 密钥
- `~/.openclaw/agents/main/agent/models.json` — 添加 code、ggboom 提供商
- `~/.openclaw/openclaw.json` — 多次修改模型优先级，最终使用 ggboom/gpt-5.2

**验证结果**:
- 端到端 LLM 调用：成功（ggboom/gpt-5.2，2-4s 响应）
- 人格一致性：成功（SOUL.md 规则生效，中文高甜模式正确触发）
- 工具调用链路：成功（savc_spawn_expert 被正确调用）
- 多 Agent 协作：部分成功（工具调用链路通，但子 Agent 未注册导致 spawn 失败）

**遗留问题**:
1. wzw 代理站对大 system prompt 的 403 过滤问题无法绕过——非 OpenClaw 可控
2. anyrouter 容量不稳定——免费资源限制
3. 子 Agent（weather、tooling 等）在 OpenClaw 中的注册需要对应模型提供商也可用
4. GPT-5.2 作为主模型时人格遵从度良好，但与 Claude 模型对 SOUL.md 的理解深度可能有差异——需后续对比

---

## 记录 04

**对话目标**: 修复 sessions_spawn 权限 + 配置子 Agent 工具权限 + 端到端多 Agent 协作验证

**执行内容**:

### 1. 修复 allowAgents 配置

- `allowAgents` 不能放在 `agents.defaults.subagents` 下（config 验证拒绝 "Unrecognized key"）
- 正确位置: `agents.list` 中 main agent 的条目下
- 修改: `agents.list[0]` 从 `{"id": "main"}` 改为 `{"id": "main", "subagents": {"allowAgents": ["*"]}}`
- OpenClaw 源码验证: `resolveAgentConfig()` 从 `cfg.agents.list` 条目读取 `subagents.allowAgents`，不从 defaults 读取

### 2. 更新 TOOLS.md 编排指南

- 原 TOOLS.md 只有基本安全规则，没有工具使用指导
- 新增"编排工具使用指南"，明确要求模型:
  - 需要联网时 **必须** 使用 `savc_spawn_expert` 派 tooling agent
  - **严禁** 说"我无法联网"（因为有 tooling agent 可以代劳）
  - 简单闲聊直接回复，复杂任务走 route → spawn 链路

### 3. 配置 per-agent 工具权限

发现子 Agent 只继承 `messaging` 工具 profile（仅有消息工具），无法实际执行任务。

为每个 Agent 配置了专属工具权限:

| Agent | profile | alsoAllow | 说明 |
|-------|---------|-----------|------|
| tooling | coding | group:web | exec + web_search + web_fetch |
| technical | coding | group:web | exec + 文件操作 + web 搜索 |
| vibe-coder | coding | group:web | exec + 文件操作 + web 搜索 |
| companion | messaging | group:memory | memory_search + memory_get |
| memory | messaging | group:memory | memory_search + memory_get |
| creative | messaging | group:memory | memory_search |
| vision | messaging | image | 图像工具 |
| voice | messaging | — | TTS 由插件处理 |

### 4. 端到端验证

**已验证通过的链路:**
- `savc_route("明天北京天气")` → tooling agent, confidence 1.00 ✅
- `savc_route("写一首诗")` → creative agent, confidence 0.82 ✅
- `savc_spawn_expert` 创建子 session → tooling sessions 目录出现新 session 文件 ✅
- GPT-5.2 直接 API 调用支持 function calling（curl 测试确认）✅
- 子 Agent 工具配置生效（systemPromptReport 确认 profile=coding+web）✅

**发现的子链路问题（已修复）:**
- 子 Agent 尝试再次调用 `savc_spawn_expert` → 被拒绝 "sessions_spawn is not allowed from sub-agent sessions"
  - 原因: 子 Agent 没有 exec/web_search 工具，只好尝试进一步委派
  - 修复: 配置 per-agent 工具权限（上述 Step 3）

**阻塞:**
- ggboom 间歇性 "No available accounts" → 多 Agent 链路需要 2+ 次 LLM 调用，对提供商稳定性要求高
- 完整 spawn 链路（main → route → spawn → sub-agent）总耗时经常超过 CLI 120s 超时
- anyrouter 持续 500 容量限制

**修改文件**:
- `~/.openclaw/openclaw.json` — allowAgents 位置修复 + 9 个 Agent 工具权限配置
- `savc-core/TOOLS.md` — 新增编排工具使用指南（含核心原则、使用流程、严禁行为）

**验证结果**:
- savc_route 调用: 成功（ggboom/gpt-5.2, 5.5s）
- savc_spawn_expert 子 session 创建: 成功
- 子 Agent 工具权限: 已配置（待提供商稳定后验证实际执行）
- 完整端到端链路: 配置正确，但受限于公益站提供商的间歇性不可用

**关键发现**:
1. OpenClaw 的 `allowAgents` 是 per-agent 设置，不能放在全局 defaults 下
2. OpenClaw 的 auth profile 有 cooldown 机制——provider 失败后自动 cooldown 数分钟，cooldown 数据存在 `auth-profiles.json` 的 `usageStats.*.cooldownUntil`
3. 子 Agent session 不能再调用 `sessions_spawn`（防止无限递归），必须给子 Agent 配置实际的工具（exec, web_search 等）
4. OpenClaw 工具 profile: minimal < messaging < coding < full，per-agent 可用 `tools.profile` + `tools.alsoAllow` 精确控制
