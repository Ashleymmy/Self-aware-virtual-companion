# 工作日志 · 2026-02-20

---

## 记录 01

**对话目标**
了解 Claude Code 当前可用 skill 列表

**执行内容**
向用户说明当前加载的两个 skill：`claude-developer-platform` 和 `ui-ux-pro-max`

**修改文件**
无

**验证结果**
未执行

---

## 记录 02

**对话目标**
为当前项目配置 Agent 级别操作权限（命令全放行，保留 Plan 审核流程）

**执行内容**
1. 读取 `.claude/settings.json` 和 `.claude/settings.local.json` 现有内容
2. 将 settings.json 中零散的 bash 白名单替换为 `Bash(*)`、`Edit(**)` 等通配符规则
3. 清空 settings.local.json 为 `{}`，避免配置冲突

**修改文件**
- `.claude/settings.json`
- `.claude/settings.local.json`

**验证结果**
未执行（配置文件写入后需在新会话中验证是否不再弹出权限确认）

---

## 记录 03

**对话目标**
基于 `docs/SAVC统一交互工作台开发计划.md` 制作 W0 阶段高保真 UI 原型，风格差异化，不使用典型 AI 配色与交互风格

**执行内容**
1. 阅读规划文档全文，理解三栏布局、四个 Tab、功能范围、数据模型等需求
2. 探索现有原型（`docs/原型.html`、`tests/codex-test/`）作为对比参考
3. 使用 `ui-ux-pro-max` skill 生成设计系统参考
4. 制定设计方向：暖色三区段（深暖棕侧栏 + 米白主区 + 暖浅灰右栏）+ 砖红强调色 + 人文衬线字体
5. 编写并写入 `tests/Claude-ui-test/index.html`（1811 行，单文件，内联 CSS + JS，CDN 字体）

**功能清单**
- 三栏完整布局（左240px + 中flex-1 + 右288px）
- 媛媛 SVG 几何头像 + 在线状态点
- 场景模式 pill 切换（陪伴/开发/排障/计划），切换联动 badge 与右侧 sceneVal
- 会话列表点击高亮（3条，含 web/discord/telegram 渠道徽章）
- 四个 Tab 切换（交互/执行/上下文/设置）
- 交互 Tab：线程式对话（含一条结构化结论+步骤卡片）+ 发送模拟（Enter/按钮）
- 执行 Tab：4条工具调用行（completed×2/failed×1/running×1），点击展开细节
- 上下文 Tab：三列网格（记忆召回/关联文档/最近提交）
- 设置 Tab：模型/TTS/Live2D 配置表单 + toggle 开关
- 右侧观测栏：会话卡片/工具迷你轨迹/统计/渠道分布

**修改文件**
- `tests/Claude-ui-test/index.html`（新建）

**验证结果**
文件行数确认：1811 行。需在浏览器中打开验证渲染效果。

**备注**
设计与现有两个原型有明显差异化：调色盘从冷蓝黑改为暖棕米白、强调色从青绿改为砖红、字体从等宽改为人文无衬线、消息从气泡改为线程竖条式。

---

## 记录 04

**对话目标**
将 `tests/Claude-ui-test/index.html` 从单栏三 Tab 版本升级为完整五视图 SPA，严格按照新版 PRD 实现

**执行内容**
1. 读取旧版 index.html 确认已有内容
2. 完整重写 `tests/Claude-ui-test/index.html`（2583 行，约 83KB）
3. 实现所有设计令牌（CSS :root 变量完整覆盖 PRD 规格）
4. 实现 5 个独立视图：
   - VIEW 1 view-companion：2栏（陪伴 presence + 聊天），SVG大头像、情绪弧形指示器、记忆 chips、气泡对话、圆角输入框
   - VIEW 2 view-dev：3栏（dev-main flex:1 + dev-right 280px），4个 Tab（交互/执行/上下文/设置），工具调用行展开折叠，右侧面板卡片
   - VIEW 3 view-debug：深色2栏，左错误树（红/黄分类点），右侧上半聊天区（error-reply 红左边条）+ resize手柄 + 下半终端日志流（12条预置日志，青色时间戳/黄色Agent名/错误行浅红背景）
   - VIEW 4 view-plan：3栏，左大纲树（激活高亮），中看板3列（待办4/进行中2/已完成3，含标签和阶段徽章），右里程碑垂直时间线（W0~W4+上线，绿/橙/灰节点）
   - VIEW 5 view-monitor：全宽纵向，顶部2×2 Agent卡片（OrchestratorAgent/MemoryAgent/VoiceAgent/Live2DAgent，含状态徽章/进度条/事件列表），中依赖关系 SVG 图（4节点带箭头+虚线/实线/点线区分状态），底部实时日志流（带过滤 chip + 清除按钮）
5. 实现全部 JS 逻辑：switchView/switchDevTab/companionSend/devSend/toggleTool/selectSession/setOutlineActive/setMonitorFilter/clearMonitorLog/monitorInterval 定时器（日志1.5s/条，进度2s循环更新）
6. 媛媛 SVG 头像（sidebar 52px + 陪伴页 100px）均采用几何圆脸暖色调实现

**修改文件**
- `tests/Claude-ui-test/index.html`（完整重写，2583 行）

**验证结果**
- 文件行数：2583；文件大小：约 83KB
- Python 脚本验证：5个 view div + 7个核心 JS 函数全部 FOUND

**备注**
单文件纯静态，可用 `file://` 协议直接在浏览器打开，仅依赖 Google Fonts CDN（Inter + Noto Sans SC + DM Serif Display），无其他外部依赖。

---

## 记录 05

**对话目标**
在陪伴模式视图中预留 Live2D 交互界面区域

**执行内容**
1. 读取 `tests/Claude-ui-test/index.html` 陪伴视图结构
2. 将陪伴视图从 2 栏（presence + chat）重构为 3 栏：
   - 左栏 200px：精简版 presence 面板（头像、情绪环、记忆 chips）
   - 中栏 380px：Live2D 显示区（canvas placeholder + 呼吸动画 + 唇形同步波形）
   - 右栏 flex-1：对话消息 + 输入框
3. Live2D 面板内容：
   - Header：标题 "Live2D" + 模式徽章（Mock/Gateway）
   - Canvas 区：媛媛 140px SVG 头像 + 身体轮廓（颈部 + 衣身渐变色块）+ 呼吸动画（translateY 3.6s）+ 唇形同步波形（7条 wf-bar，CSS keyframes）+ 角落标签 "canvas:mock · 30fps"
   - 控制区：5 个动作触发按钮（微笑/眨眼/挥手/思考/点头）+ 渲染模式切换（Gateway/Mock）
4. 新增 JS 函数：
   - `l2dAction(action)`：触发动作，临时更新 `.companion-subtitle` 文字
   - `setL2dMode(mode, el)`：切换 Gateway/Mock 模式，更新徽章与 canvas 标签文字

**修改文件**
- `tests/Claude-ui-test/index.html`（新增 ~180 行 CSS + ~80 行 HTML + ~30 行 JS，总行数 2928）

**验证结果**
- 结构验证：companion-presence / companion-live2d / companion-chat 三个 div 顺序正确
- JS 函数：l2dAction、setL2dMode 均已插入
- 总行数：2928 行

**备注**
Live2D canvas 区为占位实现，实际渲染时需将 `.live2d-canvas-area` 内的 `.live2d-figure` 替换为真实 WebGL canvas 挂载点（`<canvas id="live2d-canvas">`），并在 Gateway 模式下通过 WebSocket 接收 lipSync signal。

---

## 记录 06

**对话目标**
将 VSCode 浮动 widget 从全 mock 数据升级为三阶段完整功能落地

**执行内容**

### Phase 1 — 只读文件浏览 + 实时 Git 状态

**后端（`savc-ui/vite.config.ts`）**
新增 5 个只读 endpoint：
- `GET /__savc/fs/tree?path=&depth=` — 递归目录树（depth ≤ 4，过滤 .git/node_modules/dist），节点附带 gitStatus 徽章
- `GET /__savc/fs/read?path=` — 安全读取文件（路径沙箱至 repoRoot，≤ 512KB，推断 language）
- `GET /__savc/git/status` — 返回 branch/head/staged/unstaged/untracked
- `GET /__savc/git/log?n=` — 复用 readCommits(n)
- `GET /__savc/git/diff?path=` — unified diff 原文

**前端（`tests/Claude-ui-test/index.html`）**
- `fetchFsTree()` 动态生成文件树 DOM，支持目录展开/折叠（`vscToggleDir`）
- `vscOpenFile(filePath)` 点击文件行打开新 Tab，fetch 内容填充为编号代码行
- `fetchGitStatus()` 更新 Git 面板文件列表 + status bar branch，每 8s 轮询
- `startVscPolling()` / `stopVscPolling()` 在 expand/collapse 时启停轮询
- 新增 `id="vsc-sb-branch"` 到 status bar
- 所有 fetch 均有 graceful degradation：失败时保留 mock 数据

### Phase 2 — 写操作 + CodeMirror 6 编辑器

**后端（`savc-ui/vite.config.ts`）**
新增 4 个写操作 endpoint：
- `POST /__savc/fs/write` — 路径沙箱 + 扩展名白名单（15种）+ 最大 2MB
- `POST /__savc/git/add` — 路径验证 + execFileSync git add
- `POST /__savc/git/commit` — execFileSync git commit，返回 hash
- `GET /__savc/fs/search?q=&path=` — git grep，最多 200 条结果

同时将 `writeFileSync` 加入 `node:fs` 导入。

**前端（`tests/Claude-ui-test/index.html`）**
- `<script type="module">` 异步加载 CodeMirror 6（esm.sh CDN，`?bundle`）
- 自定义暖色主题：背景 `#1A1510`，光标 `#C8571E`，选中色半透明砖红
- 语言映射：typescript/javascript/html/css/markdown/json/yaml
- 注入 `window.vscCM.open(content, lang)` + `getContent()` + `setLang()`
- 新增 `#vsc-cm-mount` div，CSS `flex:1;overflow:hidden`
- `vscOpenFile` 优先使用 CM 渲染；CM 不可用时降级为纯文本行号显示
- `vscSaveFile()` — 读取 CM 内容 → POST fs/write，成功后 status bar 提示 "✓ 已保存"（1.5s）
- `vscStageFile(path)` — POST git/add，成功后刷新 Git 面板
- `vscCommit()` — 读取 `#vsc-git-msg` 内容 → POST git/commit，成功后清空并刷新
- Git 面板更改/未跟踪列表每行添加「+」暂存按钮
- Ctrl+S 全局键盘事件（widget 展开时）触发 vscSaveFile
- 提交按钮绑定 `onclick="vscCommit()"`，提交框添加 `id="vsc-git-msg"`

### Phase 3 — 交互式终端（WebSocket PTY）

**后端（`savc-ui/vite.config.ts`）**
- `POST /__savc/terminal/exec` — 命令白名单（12个），非交互式执行，超时 15s
- `WS /__savc/terminal` — 通过 `server.httpServer.on('upgrade')` 处理 WebSocket 握手
  - 只接受 localhost 来源，并发上限 3 个 PTY session
  - spawn node-pty（xterm-256color，220×50，cwd: repoRoot）
  - WS binary frame → pty.write()，pty.onData() → WS 发送
  - 手写 WebSocket 帧解析/组装（无额外依赖）

**`savc-ui/package.json`**
- 新增 `"@lydell/node-pty": "1.2.0-beta.3"`
- 已运行 `pnpm install` 安装完成

**顶部 import（`savc-ui/vite.config.ts`）**
- 动态 `await import("@lydell/node-pty")` 加载，失败时静默跳过（保证无 PTY 时 savc-ui 仍能启动）

**前端（`tests/Claude-ui-test/index.html`）**
- `<script type="module">` 异步加载 `xterm@5` + `xterm-addon-fit@0.8`（esm.sh CDN）
- 自定义暖色终端主题（16 色 + background `#140F0A`，cursor `#C8571E`）
- `xterm-mount` div 初始隐藏，连接成功后显示，替换 `vsc-term-mock` 静态内容
- `expandVSCode` 包装：首次展开时异步 connectPTY()，后续展开仅 fitAddon.fit()
- 窗口 resize 自动 fit
- `window.vscXterm` 暴露 terminal 实例

**修改文件**
- `savc-ui/vite.config.ts`（+350 行，1981 行总计）
- `savc-ui/package.json`（新增 @lydell/node-pty 依赖）
- `tests/Claude-ui-test/index.html`（+400 行，3955 行总计）

**验证结果**
- `npx tsc --noEmit` — 0 错误（已验证）
- `@lydell/node-pty` 已安装至 `savc-ui/node_modules/@lydell/`
- 所有 10 个后端 endpoint 均已注册（grep 验证）

**备注**
全部功能均实现 graceful degradation：savc-ui 未启动时，widget 保留 mock 数据可正常浏览；CodeMirror/xterm 加载失败时静默降级至纯文本/静态终端显示。验证命令：
```bash
pnpm --dir savc-ui dev   # 启动 localhost:5174
curl 'http://localhost:5174/__savc/fs/tree?path=.'
curl 'http://localhost:5174/__savc/git/status'
# 浏览器打开 http://localhost:5174 → 开发模式 → 点击 widget 展开
```

