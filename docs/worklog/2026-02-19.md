# 2026-02-19 工作日志

## 1) 工程收敛与安全治理落地
- 对话目标:
  - 落实“项目整体情况盘点与收敛计划（2026-02-19）”，优先处理安全风险、脚本兼容性与文档一致性。
- 执行内容:
  - 修复 `scripts/test_phase_status.sh`，移除 Bash 4 关联数组依赖，兼容 macOS 默认 Bash 3.2。
  - 新增密钥扫描与提交防护能力：`scripts/scan_secrets.sh`、`scripts/install_git_hooks.sh`、`.githooks/pre-commit`。
  - 为根工作区新增安全脚本入口：`hooks:install`、`security:scan`、`security:scan:staged`。
  - 统一工程文档与结构事实：更新 `README.md`、`docs/beta项目构建方案.md`、`pnpm-workspace.yaml`（移除失效的 `tests/glmtest`）。
  - 新增安全规范文档与基线冻结文档：`docs/密钥轮换与本地凭据管理.md`、`docs/baseline-freeze-2026-02-19.md`。
  - 对本地 `config/.env.local` 执行敏感值清空处理（不写入仓库），降低明文凭据暴露风险。
  - 执行本地 Git 历史敏感串扫描（排除 `openclaw/`），确认命中为测试假数据样例而非真实凭据。
- 修改文件:
  - `scripts/test_phase_status.sh`
  - `scripts/scan_secrets.sh`
  - `scripts/install_git_hooks.sh`
  - `.githooks/pre-commit`
  - `package.json`
  - `pnpm-workspace.yaml`
  - `README.md`
  - `docs/beta项目构建方案.md`
  - `docs/密钥轮换与本地凭据管理.md`
  - `docs/baseline-freeze-2026-02-19.md`
  - `docs/worklog/2026-02-19.md`
  - `docs/worklog/INDEX.md`
  - `config/.env.local`（本地文件，未入库）
- 验证结果:
  - `bash scripts/test_phase_status.sh --quick` 通过（Bash 3.2 环境）。
  - `bash scripts/scan_secrets.sh staged` 通过。
  - `bash scripts/scan_secrets.sh all` 通过。
  - `pnpm -s security:scan` 通过。
  - `pnpm -s security:scan:staged` 通过。
  - `bash scripts/test_phase4b.sh` 通过（PASS 26 / FAIL 0）。
  - `bash scripts/test_phase5c.sh` 通过（PASS 7 / FAIL 0）。
  - `bash scripts/test_phase5d.sh` 通过（PASS 18 / FAIL 0）。
  - `bash scripts/test_phase5e.sh` 通过（PASS 14 / WARN 1 / FAIL 0）。
  - `pnpm -r list --depth -1` 通过（工作区解析正常）。
  - `bash scripts/install_git_hooks.sh` 执行成功，`git config --get core.hooksPath` 为 `.githooks`。
  - `git log --all -n 200 -p -- . ':(exclude)openclaw' | rg ...` 命中 1 处测试样例（`RAW_SECRET`），未发现真实凭据特征。
- 备注:
  - `config/.env.local` 已清空敏感值，需按轮换后的新密钥重新填写。
  - 扫描脚本默认跳过 `openclaw/` 上游源码目录；可通过 `SAVC_SCAN_INCLUDE_OPENCLAW=1` 开启全量扫描。

## 2) OpenAI Codex 账号授权可行性排查
- 对话目标:
  - 确认 OpenClaw 是否支持 OpenAI 账号授权登录（ChatGPT OAuth / Codex），并评估当前仓库能否直接启用以提升稳定性。
- 执行内容:
  - 检查 OpenClaw CLI 命令面：`models auth`、`models auth login`、`onboard`。
  - 检查文档与源码：`docs/providers/openai.md`、`docs/concepts/oauth.md`、`src/commands/auth-choice.apply.openai.ts`、`src/commands/models/auth.ts`。
  - 实际执行验证：
    - `node openclaw.mjs models auth login --provider openai-codex --set-default`（非 TTY）确认交互要求；
    - TTY 下执行同命令，确认当前配置报错 `No provider plugins found`；
    - `node openclaw.mjs models list --json` / `models status --json`，确认当前运行模型未包含 `openai-codex/*`，仍以聚合供应商为主。
  - 结论：
    - 当前版本支持 OpenAI Codex OAuth；
    - 在此仓库环境中，推荐通过 `openclaw onboard --auth-choice openai-codex` 走内置流程；
    - `models auth login --provider openai-codex` 在当前配置下不可直接用（provider plugin 为空）；
    - Codex OAuth 仅覆盖聊天/补全，不覆盖 OpenAI embeddings（语义记忆仍需真实 `OPENAI_API_KEY`）。
- 修改文件:
  - `docs/worklog/2026-02-19.md`
- 验证结果:
  - `node openclaw.mjs --help` / `models --help` / `models auth --help` 输出正常。
  - `node openclaw.mjs models auth login --provider openai-codex --set-default`（非 TTY）返回：requires interactive TTY。
  - TTY 下同命令返回：No provider plugins found.
  - `node openclaw.mjs models list --json` 显示当前仅配置聚合 provider 模型，未包含 `openai-codex/*`。
- 备注:
  - 发现 `scripts/openclaw.sh` 在 macOS 上会因 `sed -i` 兼容性触发错误（当需要自动回写 token 时）；本次排查改用 `node openclaw.mjs` 直连命令。

## 3) 对话模型与 Agent 工作模型配置核对
- 对话目标:
  - 确认“当前主要问题是否在对话模型与 Agent 工作模型配置，而非 embeddings API”。
- 执行内容:
  - 核对 `~/.openclaw/openclaw.json` 的实际生效模型配置（默认模型、fallback、各 agent 绑定模型）。
  - 核对 `savc-core/agents/*.yaml` 的声明模型，检查与运行时是否一致。
  - 核对 `~/.openclaw/agents/main/agent/auth-profiles.json` 的 provider/auth profile，确认是否存在 `openai-codex` OAuth 资料。
  - 核对 `node openclaw.mjs models status --json` 的 auth 概览与 OAuth 状态字段。
  - 结论：
    - 你的判断基本正确：当前瓶颈主要在聊天/agent 模型链路配置一致性，不是 embeddings。
    - 运行时全部子 agent 统一绑到 `ggboom/gpt-5.2`，与 `savc-core/agents/*.yaml` 里声明的 Anthropic 模型不一致（声明未实际生效）。
    - 当前 auth profiles 中无 `openai-codex`，`providersWithOAuth` 为空，因此尚未启用 Codex OAuth 账号登录链路。
- 修改文件:
  - `docs/worklog/2026-02-19.md`
- 验证结果:
  - `node openclaw.mjs models status --json`：默认模型 `ggboom/gpt-5.2`，OAuth providers 为空。
  - `python` 读取 `~/.openclaw/openclaw.json`：`companion/memory/technical/...` 均绑定 `ggboom/gpt-5.2`。
  - `sed` 查看 `savc-core/agents/*.yaml`：声明模型多为 `anthropic/claude-*`。
  - `python` 读取 `auth-profiles.json`：provider 仅 `anyrouter/code/ggboom/laoyou`，无 `openai-codex`。
- 备注:
  - embeddings API 后续仍可独立保留；不影响先修正对话/agent 模型配置链路。

## 4) 按用户提供 API 配置对话模型 fallback
- 对话目标:
  - 在测试开发阶段优先保证模型响应稳定：保留现有主模型，同时将 fallback 扩展到用户已提供的多 API 供应商。
- 执行内容:
  - 使用 OpenClaw CLI 直接改写运行时 fallback 链（`~/.openclaw/openclaw.json`）：
    - 清空旧 fallback；
    - 依次添加 `ggboom`、`anyrouter`、`laoyou`、`code`、`anyrouter-haiku`。
  - 验证当前默认模型与 fallback 列表是否生效。
  - 同时确认 `openai-codex` 模型可见（当前未授权，`available=false`），为后续账号登录切主模型做准备。
  - 同步更新仓库 `scripts/setup.sh` 的默认 fallback 模板，避免后续重跑 setup 覆盖为旧链路。
- 修改文件:
  - `~/.openclaw/openclaw.json`（运行时配置文件，仓库外）
  - `scripts/setup.sh`
  - `docs/worklog/2026-02-19.md`
- 验证结果:
  - `node openclaw.mjs models fallbacks list --json` 返回：
    - `ggboom/gpt-5.2`
    - `anyrouter/claude-sonnet-4-5-20250929`
    - `laoyou/claude-sonnet-4-5-20250929`
    - `code/claude-sonnet-4-5-20250929`
    - `anyrouter/claude-haiku-4-5-20251001`
  - `node openclaw.mjs models status --json` 确认 fallback 已更新，默认模型仍为 `ggboom/gpt-5.2`。
  - `node openclaw.mjs models list --all --provider openai-codex --json` 可见 Codex 模型列表（当前 `available=false`，待账号 OAuth）。
  - `bash scripts/scan_secrets.sh staged` 通过（本次脚本改动未引入敏感内容）。
- 备注:
  - 账号 OAuth 完成后可切主模型到 `openai-codex/gpt-5.2`，当前 fallback 链可直接作为兜底。

## 5) OpenAI 账号授权与 fallback 最终状态复核
- 对话目标:
  - 复核“OpenAI 账号授权 + 多 API fallback”是否已达到可用状态。
- 执行内容:
  - 检查 `models status --json`：默认模型、fallback、OAuth provider 状态。
  - 检查 `models list --all --provider openai-codex --json`：确认 Codex 模型是否 `available=true`。
  - 检查 `~/.openclaw/openclaw.json` 与 `auth-profiles.json`：确认主模型/回退链与 `openai-codex:default` profile。
  - 补充核对子 agent 显式模型字段，识别是否仍固定在 `ggboom/gpt-5.2`。
- 修改文件:
  - `docs/worklog/2026-02-19.md`
- 验证结果:
  - `node openclaw.mjs models status --json`：
    - 默认模型：`openai-codex/gpt-5.2`
    - `providersWithOAuth`: `openai-codex (1)`
    - `openai-codex:default` 状态：`ok`
  - `node openclaw.mjs models list --all --provider openai-codex --json`：
    - `openai-codex/*` 模型均 `available=true`
  - `~/.openclaw/openclaw.json`：
    - fallback 保持为多 API 链（`ggboom`/`anyrouter`/`laoyou`/`code`/`haiku`）
  - 子 agent 仍显式绑定 `ggboom/gpt-5.2`（`companion/memory/technical/...`）。
- 备注:
  - 当前“主对话模型 + fallback”已可用；若要“所有子 agent 也优先走 openai-codex”，需额外调整 agent 级模型覆盖。

## 6) 用户复检：统一到 OpenAI 主模型并确认可用
- 对话目标:
  - 按“你检查一下应该是可以了”进行最终复检，确保主模型、子 agent 模型与 fallback 链一致且可用。
- 执行内容:
  - 运行环境快照核对：`node -v`、`pnpm -v`、`bash --version`。
  - 复核 OpenClaw 实时状态：`models status --json`、`models list --all --provider openai-codex --json`。
  - 发现并修正偏差：子 agent 在 `~/.openclaw/openclaw.json` 与各 `~/.openclaw/agents/*/agent/models.json` 仍为 `ggboom/gpt-5.2`，现已统一改为 `openai-codex/gpt-5.2`，并统一 fallback 链。
  - 回归验证：再次检查子 agent 模型字段和各 agent 的 `models.json` 内容。
  - 工程侧快速验收：`bash scripts/test_phase_status.sh --quick`。
- 修改文件:
  - `~/.openclaw/openclaw.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/companion/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/creative/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/memory/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/technical/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/tooling/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/vibe-coder/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/vision/agent/models.json`（运行时配置，仓库外）
  - `~/.openclaw/agents/voice/agent/models.json`（运行时配置，仓库外）
  - `docs/worklog/2026-02-19.md`
- 验证结果:
  - `node -v`：`v24.4.1`
  - `pnpm -v`：`10.23.0`
  - `bash --version`：`3.2.57(1)-release`
  - `node openclaw/openclaw.mjs models status --json`：
    - 默认模型 `openai-codex/gpt-5.2`
    - `providersWithOAuth` 包含 `openai-codex (1)`
    - OAuth 状态 `ok`
  - `node openclaw/openclaw.mjs models list --all --provider openai-codex --json`：
    - `openai-codex/*` 模型 `available=true`
  - `node openclaw/openclaw.mjs agent --local --session-id savc-check-20260219 --message 'Reply with exactly: SAVC_OK' --json`：
    - 返回文本 `SAVC_OK`
    - `agentMeta.provider=openai-codex`，`agentMeta.model=gpt-5.2`
  - `jq '.agents.list[] | select(has("model")) | {id, model}' ~/.openclaw/openclaw.json`：
    - `companion/memory/technical/creative/tooling/voice/vision/vibe-coder` 均为 `openai-codex/gpt-5.2`
  - 各子 agent `models.json`：
    - `primary` 均为 `openai-codex/gpt-5.2`
    - `fallbacks` 均为 `ggboom -> anyrouter sonnet -> laoyou sonnet -> code sonnet -> anyrouter haiku`
  - `bash scripts/test_phase_status.sh --quick` 通过。
- 备注:
  - 命令输出有一条版本提示：配置文件由较新 OpenClaw 版本写入（`2026.2.4`），当前仓库 CLI 标识为 `0.0.0`；本次不影响配置生效与运行。
