# 2026-02-17 工作日志

## 1) 项目整体进度盘点
- 对话目标: 盘点当前项目整体进度，给出已完成阶段、风险点与下一步重点。
- 执行内容:
  - 检查分支与最近提交，确认 `main` 与 `origin/main` 同步。
  - 核对 `README.md`、`docs/SAVC功能拓展路线图.md`、`tests/phase5-test-report.md`、`tests/phase6-test-report.md` 的阶段状态描述。
  - 执行 `bash scripts/test_phase_status.sh`、`bash scripts/test_phase5.sh`、`bash scripts/test_phase6.sh` 进行状态快照与回归验收。
  - 检查 `/tmp/phase2_status.log`，确认 Phase 2 失败项为 live smoke 环境变量缺失，不是核心能力回退。
- 修改文件:
  - `docs/worklog/2026-02-17.md`
  - `docs/worklog/INDEX.md`
- 验证结果:
  - `scripts/test_phase_status.sh`: Phase 1/3 通过，Phase 2 仅 `live smoke env missing`。
  - `scripts/test_phase5.sh`: PASS（5c/5d/5e 全通过，5e live smoke 按预期跳过）。
  - `scripts/test_phase6.sh`: PASS（30/30）。
- 备注:
  - 当前主要待推进项为 Phase 6 生产级通道联调与端侧稳定性收尾。

## 2) 语音与 Live2D 配置预留
- 对话目标: 追加语音与 Live2D 所需的 `.env.local` 预留配置，便于后续填写真实参数。
- 执行内容:
  - 扫描 `voice-call` 插件与 `savc-ui` Live2D 桥接代码，确认实际可用的环境变量键名。
  - 在 `config/.env.local` 追加 Phase 5d/6 配置区块，覆盖语音 provider（mock/twilio/telnyx/plivo）、可选 ngrok、TTS 增强、Live2D 前端桥接。
  - 保持幂等写入策略：仅在键不存在时追加，不覆盖现有值。
- 修改文件:
  - `config/.env.local`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - 通过 `awk` 定位并检查新增区块，确认键名已落地且格式正确。
- 备注:
  - 本次仅做配置预留，不改动运行逻辑与插件配置文件。

## 3) 真人 TTS 配置澄清
- 对话目标: 明确“是否需要真人 TTS 配置”以及当前阶段的必填项。
- 执行内容:
  - 结合现有 Phase 5d/6 方案说明 `mock` 与 `real` 两种路径下的 TTS 依赖差异。
  - 确认真人音色相关参数属于 OpenClaw `messages.tts` / `voice-call.config.tts` 配置项，不是必须写在 `.env.local` 的字段。
- 修改文件:
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - 未执行（本轮为配置说明澄清）。
- 备注:
  - 如需，我可在下一步把 `.env.local` 的 TTS 预留注释再细化为“mock最小集/real最小集”。

## 4) 补充真人 TTS 预留字段
- 对话目标: 按需追加真人 TTS 预留配置，方便后续直接填值。
- 执行内容:
  - 在 `config/.env.local` 的 Phase 5d/6 区块追加 TTS 参数预留键：
    - `VOICE_TTS_PROVIDER`
    - `VOICE_TTS_OPENAI_MODEL` / `VOICE_TTS_OPENAI_VOICE` / `VOICE_TTS_OPENAI_INSTRUCTIONS`
    - `VOICE_TTS_ELEVENLABS_MODEL_ID` / `VOICE_TTS_ELEVENLABS_VOICE_ID` / `VOICE_TTS_ELEVENLABS_BASE_URL`
  - 同步更新 `config/.env.example`，保持模板与本地配置结构一致，并补充 Phase 6 的 `VITE_*` Live2D 桥接变量。
  - 通过 `rg` 与片段检查确认新增键名存在且未重复。
- 修改文件:
  - `config/.env.local`
  - `config/.env.example`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `rg -n` 校验通过（新增键均存在，未出现重复冲突）。
- 备注:
  - 本次仅增加配置预留，不改变现有默认运行路径（mock 仍可直接使用）。

## 5) `savc-ui` 现状审查
- 对话目标: 快速评估 `savc-ui` 当前可开发状态与风险点。
- 执行内容:
  - 检查 `savc-ui` 目录结构、入口文件与 Live2D 相关模块（`app.ts` / `views/chat.ts` / `views/orchestrator.ts` / `live2d-*`）。
  - 检查当前 `savc-ui` 未提交改动差异，确认主要是字体本地化与样式微调。
  - 执行 `pnpm --dir savc-ui build` 验证构建可用。
  - 核对 `vite.config.ts`、`index.html`、`public/live2d/yuanyuan-lite.model.json` 的资源路径与默认清单。
- 修改文件:
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `pnpm --dir savc-ui build`: PASS。
  - `bash scripts/test_phase6.sh`: PASS（`PASS: 30, FAIL: 0`）。
- 备注:
  - 目前主要非阻断风险为通道订阅未显式取消（`views/chat.ts` / `views/orchestrator.ts`），长期运行可能累积无效监听。

## 6) `savc-ui` 文字可读性修复
- 对话目标: 修复管理界面“文字显示有点问题”（次级文案偏暗、占位文案可读性弱）。
- 执行内容:
  - 调整 `savc.css` 全局文本换行与断词策略，避免中文/混合文本显示异常：
    - `overflow-wrap: anywhere`
    - `line-break: auto`
    - `hyphens: auto`
  - 恢复 `status-list` 行内边距，避免状态文本贴边拥挤。
  - 提升暗色主题次级文本变量对比度（`--muted` / `--muted-strong` / `--muted-foreground`）。
  - 将 `card-sub` 改为使用 `--muted-foreground`，并提高占位卡片主文案权重。
- 修改文件:
  - `savc-ui/src/styles/savc.css`
  - `savc-ui/src/styles/base.css`
  - `savc-ui/src/styles/components.css`
  - `savc-ui/src/ui/app.ts`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `pnpm --dir savc-ui build`: PASS。
- 备注:
  - 本轮未改动业务逻辑，仅做文本可读性与视觉层修复。

## 7) `savc-ui` 显示不全（右侧裁切）修复
- 对话目标: 处理“页面显示不全”问题，避免右侧内容被裁掉。
- 执行内容:
  - 为根容器与 shell 增加全宽兜底与最小宽度约束，防止布局按内容宽度扩张后被 `overflow: hidden` 截断。
  - 为 grid 关键子项补 `min-width: 0`（`topbar/nav/content` 等），修复网格子项默认最小内容宽度导致的溢出。
  - 将 `.content` 的横向溢出策略从 `hidden` 调整为 `auto`，在极端宽内容下可滚动而不是硬裁切。
- 修改文件:
  - `savc-ui/src/styles/base.css`
  - `savc-ui/src/styles/layout.css`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `pnpm --dir savc-ui build`: PASS。
- 备注:
  - 若用户侧仍出现裁切，下一步将按实际分辨率检查浏览器缩放和移动端断点规则。

## 8) `savc-ui` 宿主样式污染隔离修复
- 对话目标: 解决“仍然显示不全”的持续问题，排查并隔离外层样式冲突。
- 执行内容:
  - 在 `app-render` 中为核心布局节点追加命名空间类：`savc-shell`、`savc-topbar`、`savc-nav`、`savc-content`。
  - 在 `layout.css` 末尾新增 Host Layout Guard：
    - 通过 `savc-app .savc-*` 高优先级规则（含 `!important`）锁定核心布局网格、尺寸、定位、滚动行为。
    - 同步补齐 `max-width: 1100px` 下的移动/平板规则，避免隔离规则破坏响应式。
  - 目标是避免外部页面对通用类名（如 `topbar/content/nav/shell`）覆盖导致的裁切与错位。
- 修改文件:
  - `savc-ui/src/ui/app-render.ts`
  - `savc-ui/src/styles/layout.css`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `pnpm --dir savc-ui build`: PASS。
- 备注:
  - 本次为结构级隔离修复，优先解决宿主 CSS 干扰引起的“显示不全”。

## 9) `savc-ui` 运行日志页网关真实对接
- 对话目标: 先完成对接，将 `logs` tab 从占位卡片改为真实网关数据视图。
- 执行内容:
  - 新增浏览器侧 Gateway WS 客户端与设备身份/令牌本地缓存模块（复用 OpenClaw 网关握手协议：`connect.challenge` + `connect`）。
  - 新增 `logs` 视图模块，对接网关方法：`status`、`health`、`logs.tail`。
  - 在 `logs` 页实现：连接状态卡片、日志等级筛选、关键词过滤、自动跟随、游标重置、状态/健康快照展示。
  - 在 `app.ts` 中接入 `logs` tab 生命周期：进入 tab 自动启动连接与轮询、离开或组件卸载时停止连接与轮询。
  - 为新网关签名逻辑追加前端依赖 `@noble/ed25519`。
- 修改文件:
  - `savc-ui/src/ui/gateway-device-auth.ts`
  - `savc-ui/src/ui/gateway-device-identity.ts`
  - `savc-ui/src/ui/gateway-ws.ts`
  - `savc-ui/src/ui/views/logs.ts`
  - `savc-ui/src/ui/app.ts`
  - `savc-ui/src/vite-env.d.ts`
  - `savc-ui/package.json`
  - `pnpm-lock.yaml`
  - `docs/worklog/2026-02-17.md`
- 验证结果:
  - `pnpm --dir savc-ui build`: PASS。
  - `pnpm --dir savc-ui exec tsc -p tsconfig.json --noEmit`: PASS。
  - `bash scripts/test_phase6.sh`: PASS（`PASS: 30, FAIL: 0`）。
- 备注:
  - 当前对接走 WebSocket RPC 直连网关，不依赖额外 SAVC 工具 allowlist；若网关策略关闭了浏览器设备鉴权降级路径，需在网关侧允许控制端连接策略。
