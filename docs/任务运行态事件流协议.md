# SAVC 任务运行态事件流协议

> 更新时间：2026-02-20
> 适用范围：`savc-ui` 开发态（Vite middleware）

## 目标

用于给 yuanyuan（管理/调度角色）提供统一的任务反馈协议，支持：

- 任务创建
- 状态推进（`queued/running/retry/succeeded/failed/canceled`）
- SSE 实时订阅
- 快照回放与调试 demo

## 状态语义

- `queued`：任务已进入队列，等待执行
- `running`：任务正在执行
- `retry`：执行失败后进入重试流程
- `succeeded`：任务成功完成
- `failed`：任务终止失败
- `canceled`：任务被取消

## 接口清单

- `GET /__savc/task-runtime/snapshot`
- `GET /__savc/task-runtime/stream`
- `POST /__savc/task-runtime/create`
- `POST /__savc/task-runtime/control`
- `POST /__savc/task-runtime/demo`

## 任务对象（RuntimeTask）

```json
{
  "id": "task-mk8l2f-a1b2c3",
  "title": "修复 Telegram 回复超时",
  "status": "running",
  "progress": 42,
  "owner": "yuanyuan",
  "channel": "telegram",
  "attempt": 1,
  "maxAttempts": 3,
  "tags": ["dev", "runtime"],
  "metadata": {},
  "createdAt": "2026-02-20T10:20:30.000Z",
  "updatedAt": "2026-02-20T10:21:00.000Z",
  "lastMessage": "子任务执行中"
}
```

## 事件对象（RuntimeTaskEvent）

```json
{
  "id": "evt-mk8l2h-z9y8x7",
  "seq": 12,
  "taskId": "task-mk8l2f-a1b2c3",
  "state": "retry",
  "progress": 26,
  "message": "首轮响应超时，触发重试",
  "owner": "yuanyuan",
  "channel": "telegram",
  "actor": "task-runtime-ui",
  "source": "api",
  "attempt": 2,
  "maxAttempts": 3,
  "timestamp": "2026-02-20T10:21:28.000Z"
}
```

## SSE 事件名

- `task_snapshot`：首次连接或刷新时发送
- `task_event`：任务状态增量事件
- `ping`：心跳包（连接保活）

## 控制接口约定

`POST /__savc/task-runtime/control`

```json
{
  "taskId": "task-mk8l2f-a1b2c3",
  "action": "running",
  "progress": 65,
  "message": "编排器已完成聚合",
  "actor": "task-runtime-ui",
  "source": "api"
}
```

- `action` 仅允许：`running/retry/succeeded/failed/canceled`
- `retry` 会自动增加 `attempt`
- `succeeded` 会强制写入 `progress=100`

## Demo 接口

`POST /__savc/task-runtime/demo`

可选 `mode`：

- `success`
- `retry-success`（默认）
- `fail`

用于在无真实后端编排时，验证前端事件流消费与展示。
